<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ระบบเก็บขยะ (Modern UI)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"> 

<style>
    body {
        font-family: 'Sarabun', sans-serif; 
        background-color: #f0f2f5;
        margin: 0;
        min-height: 100vh; 
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 15px; 
    }

    /* === ส่วนที่เพิ่ม 1: หน้าจอ Login บังไว้ก่อน === */
    #auth-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: white;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
    }
    
    /* ซ่อนเนื้อหาหลักไว้ก่อน จนกว่าจะตรวจสอบผ่าน */
    #app-content {
        display: none; 
        width: 100%;
        max-width: 480px;
        /* display: flex; จะถูกเซตด้วย JS เมื่อผ่านการตรวจสอบ */
        flex-direction: column;
        align-items: center;
    }

    /* === CSS เดิมทั้งหมด (ไม่แตะต้อง) === */
    .bin-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        width: 100%;
        max-width: 480px;
        gap: 15px;
        margin-bottom: 20px; 
    }

    .bin-card {
        display: flex;
        flex-direction: column;
        justify-content: space-evenly; 
        align-items: center;
        text-align: center;
        padding: 15px 8px;
        border-radius: 16px;
        background-color: #ffffff;
        box-shadow: 0 6px 15px rgba(0,0,0,0.08);
        transition: transform 0.1s, box-shadow 0.2s;
        min-height: 200px;
        cursor: pointer;
    }

    .bin-card:active {
        transform: scale(0.97);
        box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .bin-card img {
        width: 90px; 
        height: 90px;
        object-fit: contain;
        margin-bottom: 10px;
    }

    .bin-card p {
        font-weight: 700;
        font-size: 14px; 
        color: #333;
        margin: 0; 
    }

    .counter {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px; 
        margin-top: 10px;
    }

    .count-btn { 
        background-color: #007bff; 
        border: none;
        color: white;
        font-size: 1.2rem;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.2s, transform 0.1s;
        display: flex; 
        align-items: center;
        justify-content: center;
        font-weight: 700;
        box-shadow: 0 2px 5px rgba(0, 123, 255, 0.4);
    }

    .count-btn:hover {
        background-color: #0056b3;
    }

    .count-btn:active {
        transform: scale(0.95);
    }

    .count {
        font-size: 1.3rem;
        font-weight: 700;
        min-width: 30px;
        text-align: center;
        color: #1a1a1a;
    }

    .action-footer {
        width: 100%;
        max-width: 480px;
        display: flex;
        justify-content: space-between;
        gap: 15px;
        margin-top: 15px;
        padding-bottom: 20px; 
    }

    .btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        padding: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: white;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.2);
    }

    .reset-btn {
        background: linear-gradient(45deg, #6c757d, #495057);
    }
    .reset-btn:hover { 
        background: linear-gradient(45deg, #495057, #6c757d);
    }

    .send-btn {
        background: linear-gradient(45deg, #28a745, #1e7e34);
    }
    .send-btn:hover { 
        background: linear-gradient(45deg, #1e7e34, #28a745);
    }
    
    /* Loading Spinner */
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
        display: none;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

    <div id="auth-overlay">
        <div class="loader" id="checking-loader"></div>
        <div id="auth-msg" style="margin-bottom: 20px; color:#555;">กำลังตรวจสอบสิทธิ์...</div>
        
        <div id="g_id_onload"
             data-client_id="920053039488-npt2d4dqoqf1c2372qdctlult37tam47.apps.googleusercontent.com"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin" 
             data-type="standard" 
             data-size="large" 
             data-theme="outline" 
             data-text="sign_in_with" 
             data-shape="rectangular" 
             data-logo_alignment="left" 
             id="google-btn" 
             style="display:none;">
        </div>
    </div>

    <div id="app-content">

        <div class="bin-container">
            <div class="bin-card" id="red-bin">
                <img src="data:image/png;base64,ใส่Base64ของถังแดงที่นี่" alt="ถังขยะแดง" id="red-bin-img">
                <p>ขยะอันตรายอุตสาหกรรม</p>
                <div class="counter">
                    <button class="count-btn" onclick="changeCount('red', -1)">−</button>
                    <span id="count-red" class="count">0</span>
                    <button class="count-btn" onclick="changeCount('red', 1)">+</button>
                </div>
            </div>

            <div class="bin-card" id="green-bin">
                <img src="data:image/png;base64,ใส่Base64ของถังเขียวที่นี่" alt="ถังขยะเขียว" id="green-bin-img">
                <p>ขยะรีไซเคิล</p>
                <div class="counter">
                    <button class="count-btn" onclick="changeCount('green', -1)">−</button>
                    <span id="count-green" class="count">0</span>
                    <button class="count-btn" onclick="changeCount('green', 1)">+</button>
                </div>
            </div>

            <div class="bin-card" id="black-bin">
                <img src="data:image/png;base64,ใส่Base64ของถังดำที่นี่" alt="ถังขยะดำ" id="black-bin-img">
                <p>ขยะทั่วไป</p>
                <div class="counter">
                    <button class="count-btn" onclick="changeCount('black', -1)">−</button>
                    <span id="count-black" class="count">0</span>
                    <button class="count-btn" onclick="changeCount('black', 1)">+</button>
                </div>
            </div>

            <div class="bin-card" id="food-bin">
                <img src="data:image/png;base64,ใส่Base64ของถังเศษอาหารที่นี่" alt="ถังเศษอาหาร" id="food-bin-img">
                <p>ถังเศษอาหาร</p>
                <div class="counter">
                    <button class="count-btn" onclick="changeCount('food', -1)">−</button>
                    <span id="count-food" class="count">0</span>
                    <button class="count-btn" onclick="changeCount('food', 1)">+</button>
                </div>
            </div>
        </div>

        <div class="action-footer">
            <button class="btn reset-btn" onclick="clearCounts()">
                <i class="fas fa-redo"></i>
                รีเซ็ต
            </button>

            <button class="btn send-btn" onclick="submitData()">
                <i class="fas fa-paper-plane"></i>
                ส่งข้อมูล
            </button>
        </div>

    </div> <script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
    // ============================================
    // ส่วนที่เพิ่มใหม่: ระบบตรวจสอบสิทธิ์ (User Verification)
    // ============================================
    const VERIFY_URL = "https://script.google.com/macros/s/AKfycbz3o8olF7MGNWFZYA7IIbZScVWtL1Q5ydV-OYTVuhUoc4YfWY98gmLa2s86mcfqSqfgWQ/exec";

    window.onload = function() {
        checkPermission();
    };

    function checkPermission() {
        // เช็คในเครื่องก่อนว่าเคยผ่านไหม (Local Storage)
        const isApproved = localStorage.getItem("waste_app_approved");
        
        if (isApproved === "true") {
            // ผ่านแล้ว -> เปิดหน้าเว็บเลย
            showAppContent();
        } else {
            // ยังไม่ผ่าน -> แสดงปุ่ม Login
            document.getElementById("auth-msg").innerText = "กรุณาลงชื่อเข้าใช้เพื่อตรวจสอบสิทธิ์";
            document.getElementById("google-btn").style.display = "block";
            document.getElementById("checking-loader").style.display = "none";
        }
    }

    function handleCredentialResponse(response) {
        // เมื่อ User Login ผ่าน Google
        const responsePayload = decodeJwtResponse(response.credential);
        const email = responsePayload.email;
        
        // ซ่อนปุ่ม โชว์โหลด
        document.getElementById("google-btn").style.display = "none";
        document.getElementById("checking-loader").style.display = "block";
        document.getElementById("auth-msg").innerText = "กำลังตรวจสอบสถานะ...";

        // ยิงไปเช็คที่ Apps Script ตัวใหม่ (VERIFY_URL)
        fetch(VERIFY_URL, {
            method: "POST",
            // การเช็คสิทธิ์ต้องรอผลตอบกลับ (response) จึงห้ามใช้ no-cors
            // Script ปลายทางต้อง return ContentService.createTextOutput(JSON)
            body: JSON.stringify({ 
                email: email,
                action: "check_permission" // เผื่อ script ใหม่ต้องการ parameter นี้
            })
        })
        .then(response => response.json()) // แปลงผลลัพธ์เป็น JSON
        .then(data => {
            // ตรวจสอบเงื่อนไขตามที่ Script ใหม่ส่งกลับมา
            // เช่น { status: "approved" } หรือ { result: "pass" }
            // สมมติว่าถ้าผ่านจะส่ง status: "approved" หรือ "success"
            
            if (data.status === "approved" || data.status === "success") { 
                // ผ่าน!
                localStorage.setItem("waste_app_approved", "true"); // จำค่าไว้
                showAppContent();
            } else {
                // ไม่ผ่าน
                alert("คุณไม่มีสิทธิ์ใช้งาน หรือบัญชียังไม่ได้รับอนุมัติ");
                window.location.href = "https://ssi-building.github.io/QR-WasteCheck/Register.html";
            }
        })
        .catch(error => {
            console.error("Verification Error:", error);
            // ถ้า Script ใหม่ยังไม่ได้ทำ CORS หรือมีปัญหา network
            alert("เกิดข้อผิดพลาดในการเชื่อมต่อเพื่อตรวจสอบสิทธิ์");
            // รีเซ็ตให้ลองใหม่
            document.getElementById("google-btn").style.display = "block";
            document.getElementById("checking-loader").style.display = "none";
        });
    }

    function showAppContent() {
        document.getElementById("auth-overlay").style.display = "none";
        document.getElementById("app-content").style.display = "flex"; // เปิดหน้าแอพ
    }

    function decodeJwtResponse(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }


    // ============================================
    // ส่วนเดิม 100% (Original Logic)
    // ============================================
    const counts = { red: 0, green: 0, black: 0, food: 0 };

    function changeCount(color, delta) {
        counts[color] = Math.max(0, counts[color] + delta);
        document.getElementById(`count-${color}`).innerText = counts[color];
    }

    function clearCounts() {
        for (const bin in counts) {
            counts[bin] = 0;
            document.getElementById(`count-${bin}`).innerText = 0;
        }
    }

    function submitData() {
        let message = `ข้อมูลที่บันทึก:
    แดง (อันตราย): ${counts.red}
    เขียว (รีไซเคิล): ${counts.green}
    ดำ (ทั่วไป): ${counts.black}
    เศษอาหาร: ${counts.food}`;

        alert(message + '\nกำลังส่งข้อมูลไป Sheet...');

        const now = new Date();
        const pad = n => String(n).padStart(2, '0');

        // สำหรับ Column G = datetime (ISO)
        const dateTimeStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;

        // สำหรับ Column H = dd/mm/yyyy (Text)
        const dateOnlyStr = `${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()}`;

        const payload = {
            A: "1",
            B: "โรงจอดรถด้านหน้าป้อม",
            C: counts.red,
            D: counts.green,
            E: counts.black,
            F: counts.food,
            G: dateTimeStr,
            H: dateOnlyStr
        };

        // ใช้ URL เดิมตามที่ให้มา
        fetch("https://script.google.com/macros/s/AKfycbzKD78PXUC09K0oitJlBHqNq6HAzKz4cVLSSYj-fPJ-FGb_dOwGc8pIV3YYj8RHdBMgkA/exec", {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        }).then(() => {
            alert("ส่งข้อมูลเรียบร้อยแล้ว!");
            try { window.close(); } catch(e) { console.log(e); }
        }).catch(err => {
            console.error(err);
            alert("เกิดข้อผิดพลาดในการส่งข้อมูล");
        });
    }
</script>

</body>
</html>
