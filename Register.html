<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ลงทะเบียนผู้ใช้ - QR WasteCheck</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
h1 { color: #333; text-align: center; }
#register-card { background: #fff; padding: 20px; border-radius: 16px; box-shadow: 0 6px 15px rgba(0,0,0,0.08); width: 100%; max-width: 400px; text-align: center; }
#user-info { margin-top: 20px; display: none; }
button { padding: 12px 20px; font-size: 16px; border: none; border-radius: 12px; background: linear-gradient(45deg,#28a745,#1e7e34); color: white; cursor: pointer; }
button:hover { opacity: 0.9; }
</style>
</head>
<body>

<div id="register-card">
  <h1>ลงทะเบียนผู้ใช้ QR WasteCheck</h1>
  
  <div id="g_id_onload"
       data-client_id="920053039488-npt2d4dqoqf1c2372qdctlult37tam47.apps.googleusercontent.com"
       data-login_uri="https://ssi-building.github.io/QR-WasteCheck/Register.html"
       data-auto_prompt="false">
  </div>
  <div class="g_id_signin" data-type="standard"></div>
  
  <div id="user-info">
    <p><strong>Email:</strong> <span id="user-email"></span></p>
    <p><strong>Name:</strong> <span id="user-name"></span></p>
    <button onclick="registerUser()">ลงทะเบียน</button>
  </div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
let userEmail = '';
let userName = '';

// ฟังก์ชัน callback เมื่อผู้ใช้ Sign-In สำเร็จ
function handleCredentialResponse(response) {
    const jwt = response.credential;
    const base64Url = jwt.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const payload = JSON.parse(window.atob(base64));

    userEmail = payload.email;
    userName = payload.name;

    document.getElementById('user-email').innerText = userEmail;
    document.getElementById('user-name').innerText = userName;
    document.getElementById('user-info').style.display = 'block';
}

// ฟังก์ชันส่งข้อมูลลง Sheet
function registerUser() {
    if (!userEmail) return alert("กรุณา Sign in ก่อน");

    const url = `https://script.google.com/macros/s/AKfycbXgbcoyebiSeGzf22jcT-LaEWDJF8zdnKTBHGk_qunGypUDcDby-ZQ-xNzFwGyh6BO/exec?email=${encodeURIComponent(userEmail)}&name=${encodeURIComponent(userName)}`;

    // ใช้ no-cors เพราะ Web App ไม่ได้อนุญาต CORS
    fetch(url, { mode: 'no-cors' })
      .then(() => {
          alert("ลงทะเบียนเรียบร้อยแล้ว!");
      })
      .catch(err => {
          console.error(err);
          alert("เกิดข้อผิดพลาดในการลงทะเบียน");
      });
}

// เรียก Google Sign-In
window.onload = function() {
    google.accounts.id.initialize({
        client_id: "920053039488-npt2d4dqoqf1c2372qdctlult37tam47.apps.googleusercontent.com",
        callback: handleCredentialResponse
    });
    google.accounts.id.renderButton(
        document.querySelector(".g_id_signin"),
        { theme: "outline", size: "large", width: 240 }
    );
}
</script>

</body>
</html>
